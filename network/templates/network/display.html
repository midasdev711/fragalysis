{% load static %}

{# Load the tag library #}
{% load bootstrap3 %}

{# Load CSS and JavaScript #}
{% bootstrap_css %}
<script src="{% bootstrap_jquery_url %}" type="text/javascript"></script>
{% bootstrap_javascript %}

<script type="text/javascript" src='{% static 'nprogress/nprogress.js' %}'></script>
<script type="text/javascript" src='{% static '@shopify/draggable/lib/draggable.bundle.js' %}'></script>
<script type="text/javascript" src="https://unpkg.com/isotope-layout@3/dist/isotope.pkgd.js"></script>
<link rel='stylesheet' href='{% static 'nprogress/nprogress.css' %}'/>

{# Display django.contrib.messages as Bootstrap alerts #}
{% bootstrap_messages %}
<script>
    // init Isotope
var $grid = $('.grid').isotope({
  itemSelector: '.compound',
  layoutMode: 'fitRows',
  getSortData: {
    name: '.name',
    symbol: '.symbol',
    number: '.number parseInt',
    category: '[data-category]',
    weight: function( itemElem ) {
      var weight = $( itemElem ).find('.weight').text();
      return parseFloat( weight.replace( /[\(\)]/g, '') );
    }
  }
});

// bind filter button click
$('#filters').on( 'click', 'button', function() {
  var filterValue = $( this ).attr('data-filter');
  // use filterFn if matches value
  filterValue = filterFns[ filterValue ] || filterValue;
  $grid.isotope({ filter: filterValue });
});

// bind sort button click
$('#sorts').on( 'click', 'button', function() {
  var sortByValue = $(this).attr('data-sort-by');
  $grid.isotope({ sortBy: sortByValue });
});

// change is-checked class on buttons
$('.button-group').each( function( i, buttonGroup ) {
  var $buttonGroup = $( buttonGroup );
  $buttonGroup.on( 'click', 'button', function() {
    $buttonGroup.find('.is-checked').removeClass('is-checked');
    $( this ).addClass('is-checked');
  });
});


       function fillDiv(query_url,input_data,div_id,nprogress)
       {
           if (nprogress==true){
               NProgress.start();
           }
           $.get(query_url, input_data,
                   function (data) {
                       document.getElementById(div_id).innerHTML = data;
                       if (nprogress==true){
                           NProgress.done();
                       }
                   });

       }
       function getData(query_url,input_data)
       {
               NProgress.start();
           $.getJSON(query_url, input_data,
                   function (data) {

                       var data_div = $(document.getElementById("data_grid"));

                       for (var depth in data){
                           // Add this as a depth option

                           var new_loop = data[depth]

                           for (var sub_type in new_loop) {

                               // Add this as sub_type option

                                   // Add this filter
                               // Generate a div within this (ADDITION, DELETION, LINKER)
                               var newer_loop = new_loop[sub_type];
                               var counter = 0;
                               for (var sub_mol in newer_loop){


                                   // Generate a div within with an image of the molecule
                                   var div_id = sub_type+"_"+depth+"_"+counter;
                                   counter +=1;
                                   var compoundDiv = document.createElement("div");
                                   compoundDiv.id = div_id;
                                   data_div.append(compoundDiv);
                                   compoundDiv.setAttribute('class',sub_type+" compound depth_"+depth)

                                   fillDiv("/viewer/mol_view",{smiles: sub_mol, return: "svg"},div_id,false);
                                   // Onclick it moves all the molecules into a viewer div

                               }

                           }

                       }
                       NProgress.done();
                   });

       }

    function makeQuery(url) {
        var smiles = document.getElementById("smiles").value;
        var num_picks = document.getElementById("num_picks").value;
        fillDiv("/viewer/mol_view",{smiles: smiles, return: "svg"},"query_mol",nprogress=false);
        getData(url,{smiles: smiles, num_picks: num_picks, return: "json"},nprogress=true);

    }
</script>


<div class="row">
        <div class="col-12">
            </div>

</div>
<div class="row">
    <div class="col-xs-0 col-md-0 col-lg-1"></div>
    <div class="col-xs-6 col-md-3">
        <label for="smiles">Smiles:</label>
        <input type="text" placeholder="O=C(COC=1C=CC=CC1)NC2CCCCC2" class="form-control" id="smiles">
        <label for="num_picks">Number of picks:</label>
        <input type="text" class="form-control" id="num_picks">
        {% buttons %}
        <button onclick="makeQuery('/network/full_graph/')" class="btn btn-primary">
          {% bootstrap_icon "eye-open" %} Full Graph
        </button>
            <button onclick="makeQuery('/network/pick_mols/')" class="btn btn-primary">
          {% bootstrap_icon "star" %} Pick Mols
        </button>
            <button onclick="makeQuery('/network/query_db/')" class="btn btn-primary">
          {% bootstrap_icon "star" %} Query Db
        </button>
        {% endbuttons %}
    <div id="query_mol">

    </div>
    </div>
    <div class="col-xs-6 col-md-3" style="max-width: 100%; max-height: 100%" id="output">
        <h2>Filter</h2>
        <div id="filters" class="button-group">
        <button class="button is-checked" data-filter="*">show all</button>
        <button class="button" data-filter=".ADDITION">Addition</button>
        <button class="button" data-filter=".DELETION">Deletion</button>
        <button class="button" data-filter=".LINKER">Linker</button>
        <button class="button" data-filter=".depth_0">Depth 0</button>
        <button class="button" data-filter=".depth_1">Depth 1</button>
            </div>
        <h2>Sort</h2>
        <div id="sorts" class="button-group">
            <button class="button is-checked" data-sort-by="original-order">original order</button>
        </div>
        <div id="data_grid" class="grid col-lg-12"></div>
    </div>
</div>