{% load static %}
<script type="text/javascript" src='{% static 'nprogress/dist/nprogress.js' %}'></script>
<script type="text/javascript" src='{% static 'ngl/dist/ngl.js' %}'></script>

{# Load the tag library #}
{% load bootstrap3 %}

{# Load CSS and JavaScript #}
{% bootstrap_css %}
<script src="{% bootstrap_jquery_url %}" type="text/javascript"></script>


<script>

    function getJsonView() {
        // Get component (path) -> representation (parameters)
        var out_data = new Array()
        state.stage.eachComponent(function (component) {
            var component_data = {"file_path": component.object.path,
            "repr": new Array(),
            "file_ext": component.parameters["ext"]};
            component.eachRepresentation(function (repr) {
                var my_params = {"data": repr.getParameters()};
                my_params["name"] = repr["parameters"]["name"];
               component_data["repr"].push(my_params);
            })
            out_data.push(component_data)
        });
        return out_data
    }

    function setJsonView(input_json){
        var obj = JSON.parse(input_json);
        // Loop through dict
        for (index = 0; index < obj.length; ++index)
        {
        // Generate the ey value pairs
            var propt = obj[index];
            state.stage.loadFile(propt["file_path"],{ ext: propt["file_ext"] })
                    .then( function( comp ){
                        for (j=0; j<propt["repr"].length; ++j) {
                            comp.addRepresentation(propt["repr"][j]["name"], propt["repr"][j]["data"]);
                        }
                    } );
        }
    }

    function post_view(title){
        var scene  = getJsonView();
        $.ajax({
          type: "POST",
          url: "/viewer/post_view",
          data: {"title": title,
          "scene": scene},
          success: function(response){ $( ".result" ).html( response); }
        }).fail(function() { alert( "error" ); });
    }

    function fillDiv(query_url,input_data,div_id,nprogress)
       {
           if (nprogress==true){
               NProgress.start();
           }
           $.get(query_url, input_data,
                   function (data) {
                       document.getElementById(div_id).innerHTML = data;
                       if (nprogress==true){
                           NProgress.done();
                       }
                   });

       }

    function fill_imgs() {
        var mol_pk_array = [
            {% for mol in mols %}
                {{ mol.pk }},
            {% endfor %}
        ]
        for (j = 0; j < mol_pk_array.length; ++j) {
            fillDiv("/viewer/img_from_pk", {"pk": mol_pk_array[j]}, "molecule_"+mol_pk_array[j].toString(), false)
        }
    }

    function load_mol(mol_pk) {
        stage.loadFile("/viewer/mol_from_pk?pk="+mol_pk.toString(),  {ext: "sdf" }).then(function (o) {
            o.addRepresentation("ball+stick", { })
            o.autoView()
})
    }

    function load_prot(prot_pk) {
        stage.loadFile("/viewer/prot_from_pk?pk=" + prot_pk.toString(), {ext: "pdb"}).then(function (o) {
            o.addRepresentation("cartoon", {})
            o.autoView()
        })
    }

    $('document').ready( function() {
        fill_imgs();
        // Create NGL Stage object
        stage = new NGL.Stage("viewport");
        // Handle window resizing
        window.addEventListener("resize", function (event) {
            stage.handleResize();
        }, false);
    })

</script>
{% bootstrap_javascript %}


<div class="container-fluid">

<div class="row">
        <div class="col-4">
            {% for mol in mols %}
             <div id="molecule_{{ mol.pk }}" onclick="load_mol({{ mol.pk }})"
                  ondblclick="load_prot({{ mol.prot_id_id }})">
                 { mol.smiles }}
             </div>
{% endfor %}
        </div>
    <div class="col-8">
        <div id="viewport" style="height: 500px;"></div>
    </div>
</div>

</div>